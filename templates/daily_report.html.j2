<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
  <meta charset="utf-8" />
  <title>{{ report_title }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <style>
    body {
        font-family: 'Merriweather', serif;
    }
    :root {
      --bvt-dark-teal: #1A8A85;
      --bvt-light-blue: #2C9FD3;
      --bs-primary: var(--bvt-dark-teal);
      --bs-primary-rgb: 26, 138, 133;
      --bs-link-color-rgb: 21, 115, 110;
      --bs-body-bg: #f8f9fa;
      --select-arrow: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24'%3E%3Cpath fill='%23212121' d='M6.293 9.293a1 1 0 0 1 1.414 0L12 13.586l4.293-4.293a1 1 0 1 1 1.414 1.414l-5 5a1 1 0 0 1-1.414 0l-5-5a1 1 0 0 1 0-1.414Z'/%3E%3C/svg%3E");
    }

    [data-bs-theme="dark"] {
      --bs-body-bg: #111315;
      --bs-body-color: #EAEAEA;
      --bs-border-color: #333;
      --bs-tertiary-bg: #15181c;
      --bs-primary: var(--bvt-light-blue);
      --bs-primary-rgb: 44, 159, 211;
      --select-arrow: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24'%3E%3Cpath fill='%23EAEAEA' d='M6.293 9.293a1 1 0 0 1 1.414 0L12 13.586l4.293-4.293a1 1 0 1 1 1.414 1.414l-5 5a1 1 0 0 1-1.414 0l-5-5a1 1 0 0 1 0-1.414Z'/%3E%3C/svg%3E");
    }

    .card-header {
        background-color: var(--bvt-dark-teal);
        color: #fff;
    }
    
    [data-bs-theme="dark"] .card-header {
        background-color: var(--bs-tertiary-bg);
        border-bottom: 1px solid #444;
    }

    .table > thead {
        background-color: var(--bvt-dark-teal);
        color: #fff;
    }
    
    [data-bs-theme="dark"] .table > thead {
        background-color: #1F2937;
    }

    .donut {
      width: 170px;
      height: 170px;
      border-radius: 50%;
      position: relative;
      box-shadow: var(--bs-box-shadow-sm);
    }
    .donut::after {
      content: "";
      position: absolute;
      inset: 34px;
      background: var(--bs-tertiary-bg, var(--bs-body-bg));
      border-radius: 50%;
    }
    
    .table-responsive {
      max-height: 60vh;
    }

    thead th {
      position: sticky;
      top: 0;
      z-index: 2;
    }
    
    .status-pill {
      padding: .2em .6em;
      border-radius: .25rem;
      font-size: .875em;
      font-weight: 600;
    }
    .status-ok { background-color: rgba(22, 163, 74, 0.18); color: #16a34a;}
    .status-fail { background-color: rgba(239, 68, 68, 0.18); color: #ef4444;}
    .status-blocked { background-color: rgba(245, 158, 11, 0.18); color: #f59e0b;}
    .status-retest { background-color: rgba(59, 130, 246, 0.18); color: #3b82f6;}
    .status-untested { background-color: rgba(108, 117, 125, 0.18); color: #6c757d;}

    .modal-image-wrap img, .modal-image-wrap video {
        max-width: 100%;
        max-height: 60vh;
        border-radius: var(--bs-border-radius);
    }
    select,
    .form-select {
        background-image: var(--select-arrow);
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        background-size: 12px;
        padding-right: 2.25rem;
        appearance: none;
    }
    .theme-toggle {
        width: 74px;
        height: 34px;
        border-radius: 999px;
        border: none;
        background: rgba(15,23,42,0.08);
        padding: 4px;
        display: inline-flex;
        align-items: center;
        cursor: pointer;
        transition: background .3s ease;
    }
    [data-bs-theme="dark"] .theme-toggle {
        background: rgba(255,255,255,0.18);
    }
    .theme-toggle-thumb {
        width: 26px;
        height: 26px;
        border-radius: 50%;
        background: #fff;
        color: #111;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: transform .3s ease, background .3s ease, color .3s ease, box-shadow .3s ease;
        box-shadow: 0 4px 12px rgba(15,23,42,0.2);
    }
    .theme-toggle-thumb svg {
        width: 16px;
        height: 16px;
        fill: currentColor;
    }
    .theme-toggle[data-mode="dark"] .theme-toggle-thumb {
        transform: translateX(38px);
        background: #0f172a;
        color: #f8fafc;
        box-shadow: 0 4px 12px rgba(0,0,0,0.45);
    }
    .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
    }
  </style>
</head>
<body>
  <div class="container my-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="h3 mb-0">{{ report_title }}</h1>
      <div>
        <button id="theme-toggle" type="button" class="theme-toggle" aria-label="Switch to dark mode" title="Switch to dark mode" data-mode="light">
          <span class="sr-only">Toggle theme</span>
          <span class="theme-toggle-thumb" aria-hidden="true">
            <span id="report-theme-icon"></span>
          </span>
        </button>
        <button type="button" class="btn btn-primary btn-sm d-inline-flex align-items-center justify-content-center" onclick="downloadHTML()" aria-label="Download HTML" title="Download HTML">
          <svg viewBox="0 0 24 24" width="16" height="16" class="me-1"><path fill="currentColor" d="M12 3a1 1 0 0 1 1 1v9.586l2.293-2.293a1 1 0 1 1 1.414 1.414l-4.002 4.002a1 1 0 0 1-1.414 0l-4.002-4.002a1 1 0 0 1 1.414-1.414L11 13.586V4a1 1 0 0 1 1-1Zm-7 14a1 1 0 0 1 1 1v2h12v-2a1 1 0 0 1 2 0v3a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1Z"/></svg>
          Download
        </button>
      </div>
    </div>

    <p class="text-muted small"><b>Generated:</b> {{ generated_at }}</p>
    <p>
      <b>Project:</b>
      {% if base_url and project_id %}
        <a href="{{ base_url }}/index.php?/projects/overview/{{ project_id }}" target="_blank" rel="noopener">{{ project_name }}</a>
      {% else %}
        {{ project_name }}
      {% endif %}
      {% if plan_name and plan_id %}
        | <b>Plan:</b> <a href="{{ base_url }}/index.php?/plans/view/{{ plan_id }}" target="_blank" rel="noopener">{{ plan_name }}</a>
      {% endif %}
    </p>

    <div class="row g-3">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">Project Status</div>
                <div class="card-body">
                    <div class="d-flex align-items-center flex-wrap">
                        <div class="donut me-3" style="background: {{ donut_style }}"></div>
                        <div>
                        {% if donut_legend and donut_legend|length > 0 %}
                            {% for seg in donut_legend %}
                            <div class="d-flex align-items-center gap-2 my-1">
                                <span style="display:inline-block; width:12px; height:12px; background: {{ seg.color }}; border-radius:2px;"></span>
                                <span>{{ seg.label }}: {{ seg.count }} ({{ seg.percent }}%)</span>
                            </div>
                            {% endfor %}
                        {% else %}
                            <span>No data</span>
                        {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">Summary</div>
                <div class="card-body">
                    <p class="mb-0">Total: {{ summary.total }} | Passed: {{ summary.Passed }} | Failed: {{ summary.Failed }} | Pass Rate: {{ summary.pass_rate }}%</p>
                </div>
            </div>
        </div>
    </div>


    {% for t in tables %}
    <div class="card mt-4 run-card" id="run-{{ t.run_id }}" data-run-id="{{ t.run_id }}">
      <div class="card-header">
        <h3 class="h5 mb-0">Run #{{ t.run_id }}{% if t.run_name %} - {{ t.run_name }}{% endif %}</h3>
      </div>
      <div class="card-body">
        <div class="text-muted small mb-2">Pass Rate: {{ t.pass_rate }}%</div>
        {% if t.refs %}
        <div class="text-muted small mb-2">
          <b>Refs:</b>
          {% for ref in t.refs %}
            <a href="{{ jira_base }}{{ ref }}" target="_blank" rel="noopener">{{ ref }}</a>{% if not loop.last %}, {% endif %}
          {% endfor %}
        </div>
        {% endif %}
        
        <div class="d-flex align-items-center flex-wrap gap-3 mb-3">
            <div class="donut" style="width:110px; height:110px; background: {{ t.donut_style }}"></div>
            <div>
                {% for seg in t.donut_legend %}
                <div class="d-flex align-items-center gap-2 small">
                    <span style="display:inline-block; width:10px; height:10px; background: {{ seg.color }}; border-radius:2px;"></span>
                    <span>{{ seg.label }}: {{ seg.count }}</span>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="run-chips btn-toolbar mb-3" role="toolbar" data-run-id="{{ t.run_id }}">
            <div class="btn-group btn-group-sm flex-wrap">
                <button type="button" class="btn btn-outline-secondary active" data-status="">All</button>
                {% for label in ['Failed','Blocked','Retest','Untested','Passed'] %}
                    {% set c = t.counts[label] | default(0) %}
                    {% if c > 0 %}
                    <button type="button" class="btn btn-outline-secondary" data-status="{{ label }}">{{ label }} ({{ c }})</button>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <div class="table-controls row g-2 align-items-center" data-run-id="{{ t.run_id }}">
            <div class="col-md-3">
                <input type="search" class="form-control form-control-sm table-filter" placeholder="Search keyword..." data-run-id="{{ t.run_id }}">
            </div>
            <div class="col-md-2">
                <select class="form-select form-select-sm filter-status" data-run-id="{{ t.run_id }}">
                    <option value="">All Statuses</option>
                    <option value="Passed">Passed</option>
                    <option value="Failed">Failed</option>
                    <option value="Blocked">Blocked</option>
                    <option value="Retest">Retest</option>
                    <option value="Untested">Untested</option>
                </select>
            </div>
            <div class="col-md-2">
                <select class="form-select form-select-sm filter-assignee" data-run-id="{{ t.run_id }}">
                    <option value="">All Assignees</option>
                </select>
            </div>
            <div class="col-md-2">
                <select class="form-select form-select-sm filter-priority" data-run-id="{{ t.run_id }}">
                    <option value="">All Priorities</option>
                </select>
            </div>
            <div class="col-auto">
                <div class="form-check">
                    <input type="checkbox" class="form-check-input filter-hide-untested" id="hide-untested-{{t.run_id}}" data-run-id="{{ t.run_id }}">
                    <label class="form-check-label small" for="hide-untested-{{t.run_id}}">Hide Untested</label>
                </div>
            </div>
            <div class="col-md-1">
                <select class="form-select form-select-sm page-size" data-run-id="{{ t.run_id }}">
                    <option value="10" selected>10</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
            </div>
        </div>

        <div class="table-responsive mt-3" id="wrap-{{ t.run_id }}">
          <table class="table table-sm table-hover table-bordered" id="table-{{ t.run_id }}">
            <thead class="table-light">
              <tr>
                <th data-sort-by="test_id" style="width:8%">ID</th>
                <th data-sort-by="title" style="width:36%">Title</th>
                <th data-sort-by="status_name" style="width:12%">Status</th>
                <th data-sort-by="assignee" style="width:15%">Assignee</th>
                <th data-sort-by="priority" style="width:10%">Priority</th>
                <th style="width:9%">Refs</th>
                <th style="width:10%">Attachments</th>
              </tr>
            </thead>
            <tbody id="rows-{{ t.run_id }}">
              {% for r in t.rows %}
              <tr data-status="{{ (r.status_name or '')|string|lower }}" data-assignee="{{ (r.assignee or '')|string|lower }}" data-priority="{{ (r.priority or '')|string|lower }}">
                <td>
                  {% if base_url and r.test_id %}
                    <a href="{{ base_url }}/index.php?/tests/view/{{ r.test_id }}" target="_blank" rel="noopener">{{ r.test_id }}</a>
                  {% else %}
                    {{ r.test_id }}
                  {% endif %}
                </td>
                <td>{{ r.title }}</td>
                <td>
                  {% if r.status_name == 'Passed' %}<span class="status-pill status-ok">Passed</span>
                  {% elif r.status_name == 'Failed' %}<span class="status-pill status-fail">Failed</span>
                  {% elif r.status_name == 'Blocked' %}<span class="status-pill status-blocked">Blocked</span>
                  {% elif r.status_name == 'Retest' %}<span class="status-pill status-retest">Retest</span>
                  {% elif r.status_name == 'Untested' %}<span class="status-pill status-untested">Untested</span>
                  {% else %}{{ r.status_name }}
                  {% endif %}
                </td>
                <td>{{ r.assignee or '' }}</td>
                <td>{{ r.priority or '' }}</td>
                <td>
                  {% if r.refs %}
                    {% for ref in r.refs %}
                      <a href="{{ jira_base }}{{ ref }}" target="_blank" rel="noopener">{{ ref }}</a>{% if not loop.last %}, {% endif %}
                    {% endfor %}
                  {% endif %}
                </td>
                <td>
                  {% set attachments = r.attachments or [] %}
                  {% set attachment_count = attachments|length %}
                  {% if attachment_count > 0 or (r.comment and r.comment|length > 0) %}
                    <button type="button" class="btn btn-outline-primary btn-sm attachment-trigger"
                            data-run="{{ t.run_id }}"
                            data-test="{{ r.test_id }}"
                            data-title="{{ r.title|e }}"
                            data-comment="{{ r.comment|default('', true)|e }}"
                            data-attachments='{{ attachments|tojson }}'>
                      View ({{ attachment_count }})
                    </button>
                    {% set skipped_count = attachments|selectattr('skipped')|list|length %}
                    {% if skipped_count > 0 %}
                      <div class="text-muted small mt-1">
                        {{ skipped_count }} attachment{% if skipped_count != 1 %}s{% endif %} too large.
                      </div>
                    {% endif %}
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div class="d-flex justify-content-end align-items-center mt-2 table-pager" data-run-id="{{ t.run_id }}">
            <span class="text-muted small me-2 pager-info" data-run-id="{{ t.run_id }}"></span>
            <div class="btn-group btn-group-sm">
                <button type="button" class="btn btn-outline-secondary pager-prev" data-run-id="{{ t.run_id }}">Prev</button>
                <button type="button" class="btn btn-outline-secondary pager-next" data-run-id="{{ t.run_id }}">Next</button>
            </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <div class="modal fade" id="attachmentModal" tabindex="-1" aria-labelledby="attachmentModalTitle" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <div>
            <h5 class="modal-title" id="attachmentModalTitle">Attachments</h5>
            <div id="attachmentModalSubtitle" class="text-muted small"></div>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="modal-image-wrap text-center mb-3">
            <img id="attachmentModalImage" alt="Attachment evidence" style="display:none;" />
            <video id="attachmentModalVideo" controls playsinline style="display:none;"></video>
          </div>
        </div>
        <div class="modal-footer justify-content-between">
            <div class="btn-group">
                <button type="button" class="btn btn-outline-secondary" id="prevAttachment">⟨ Prev</button>
                <button type="button" class="btn btn-outline-secondary" id="nextAttachment">Next ⟩</button>
            </div>
            <div class="text-muted small" id="attachmentCounter"></div>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <script>
    const themeToggle = document.getElementById('theme-toggle');
    const themeIcon = document.getElementById('report-theme-icon');
    const htmlEl = document.documentElement;
    const sunIcon = '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 4.75a.75.75 0 0 1 .75-.75h.5a.75.75 0 0 1 0 1.5h-.5A.75.75 0 0 1 12 4.75Zm5.657 2.093a.75.75 0 1 1 1.06 1.06l-.354.354a.75.75 0 0 1-1.06-1.06l.354-.354ZM5.637 6.843a.75.75 0 0 1 1.06-1.06l.354.353a.75.75 0 0 1-1.06 1.061l-.354-.354ZM12 7.5A4.5 4.5 0 1 1 7.5 12 4.505 4.505 0 0 1 12 7.5Zm0 1.5A3 3 0 1 0 15 12a3 3 0 0 0-3-3Zm7.25 3.25a.75.75 0 0 1 0 1.5h-.5a.75.75 0 0 1 0-1.5h.5Zm-13 .75a.75.75 0 0 1-.75.75h-.5a.75.75 0 0 1 0-1.5h.5a.75.75 0 0 1 .75.75Zm10.657 4.657a.75.75 0 0 1 1.06 0l.354.354a.75.75 0 1 1-1.06 1.06l-.354-.353a.75.75 0 0 1 0-1.061Zm-10.657 0a.75.75 0 0 1 0 1.061l-.354.353a.75.75 0 0 1-1.06-1.06l.354-.354a.75.75 0 0 1 1.06 0Zm5.75.75a.75.75 0 0 1 .75.75v.5a.75.75 0 0 1-1.5 0v-.5a.75.75 0 0 1 .75-.75Z"/></svg>';
    const moonIcon = '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M21 14.5A8.5 8.5 0 1 1 9.5 3a.75.75 0 0 1 .808.407 6.5 6.5 0 0 0 10.285 7.186.75.75 0 0 1 .407.808z"/></svg>';

    function updateThemeIcon(theme) {
        const nextLabel = theme === 'dark' ? 'Switch to light mode' : 'Switch to dark mode';
        themeToggle.setAttribute('aria-label', nextLabel);
        themeToggle.setAttribute('title', nextLabel);
        themeToggle.dataset.mode = theme;
        themeIcon.innerHTML = theme === 'dark' ? sunIcon : moonIcon;
    }

    function applyTheme(theme) {
        htmlEl.setAttribute('data-bs-theme', theme);
        updateThemeIcon(theme);
    }

    themeToggle.addEventListener('click', () => {
        const currentTheme = htmlEl.getAttribute('data-bs-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        localStorage.setItem('theme', newTheme);
        applyTheme(newTheme);
    });

    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) {
        applyTheme(savedTheme);
    } else {
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        applyTheme(prefersDark ? 'dark' : 'light');
    }
    (function() {
      function setupInteractiveTable(runId) {
        const table = document.getElementById('table-' + runId);
        const tbody = document.getElementById('rows-' + runId);
        const filterInput = document.querySelector('.table-filter[data-run-id="' + runId + '"]');
        const statusSel = document.querySelector('.filter-status[data-run-id="' + runId + '"]');
        const assigneeSel = document.querySelector('.filter-assignee[data-run-id="' + runId + '"]');
        const prioritySel = document.querySelector('.filter-priority[data-run-id="' + runId + '"]');
        const hideUntested = document.querySelector('.filter-hide-untested[data-run-id="' + runId + '"]');
        const pageSizeSel = document.querySelector('.page-size[data-run-id="' + runId + '"]');
        const pager = document.querySelector('.table-pager[data-run-id="' + runId + '"]');
        const prevBtn = pager ? pager.querySelector('.pager-prev') : null;
        const nextBtn = pager ? pager.querySelector('.pager-next') : null;
        const pagerInfo = pager ? pager.querySelector('.pager-info') : null;
        const chips = document.querySelectorAll('.run-chips[data-run-id="' + runId + '"] button');
        if (!table || !tbody || !filterInput) return;

        let rows = Array.from(tbody.querySelectorAll('tr'));
        const uniq = (arr) => Array.from(new Set(arr)).filter(Boolean).sort((a, b) => a.localeCompare(b));
        const assignees = uniq(rows.map(r => (r.dataset.assignee || '').trim()).filter(Boolean));
        const priorities = uniq(rows.map(r => (r.dataset.priority || '').trim()).filter(Boolean));
        if (assigneeSel && assignees.length) {
          assigneeSel.innerHTML = '<option value="">All Assignees</option>' + assignees.map(a => `<option>${a}</option>`).join('');
        }
        if (prioritySel && priorities.length) {
          prioritySel.innerHTML = '<option value="">All Priorities</option>' + priorities.map(p => `<option>${p}</option>`).join('');
        }

        const pageSizeKey = 'report_page_size_' + runId;
        let pageSize = parseInt(localStorage.getItem(pageSizeKey) || (pageSizeSel ? pageSizeSel.value : '10'), 10);
        if (isNaN(pageSize) || pageSize <= 0) pageSize = 10;
        let pageIndex = 0;
        let filteredRows = rows.slice();

        function renderPage() {
          const start = pageIndex * pageSize;
          const end = start + pageSize;
          tbody.innerHTML = ''; // Clear and re-append
          filteredRows.slice(start, end).forEach(r => tbody.appendChild(r));
          
          const total = filteredRows.length;
          if (pagerInfo) {
            const shownStart = total ? start + 1 : 0;
            const shownEnd = Math.min(total, end);
            pagerInfo.textContent = `${shownStart}-${shownEnd} of ${total}`;
          }
          if (prevBtn) prevBtn.disabled = pageIndex <= 0;
          if (nextBtn) nextBtn.disabled = end >= filteredRows.length;
        }

        function applyFilters() {
          const text = (filterInput.value || '').toLowerCase();
          const status = (statusSel && statusSel.value) || '';
          const assignee = (assigneeSel && assigneeSel.value || '').toLowerCase();
          const priority = (prioritySel && prioritySel.value || '').toLowerCase();
          const hideU = !!(hideUntested && hideUntested.checked);
          filteredRows = rows.filter(row => {
            const rowText = row.textContent.toLowerCase();
            const rs = (row.dataset.status || '');
            const ra = (row.dataset.assignee || '');
            const rp = (row.dataset.priority || '');
            if (text && !rowText.includes(text)) return false;
            if (status && rs !== status.toLowerCase()) return false;
            if (assignee && ra !== assignee) return false;
            if (priority && rp !== priority) return false;
            if (hideU && rs === 'untested') return false;
            return true;
          });
          pageIndex = 0;
          renderPage();
        }

        filterInput.addEventListener('input', applyFilters);
        if (statusSel) statusSel.addEventListener('change', applyFilters);
        if (assigneeSel) assigneeSel.addEventListener('change', applyFilters);
        if (prioritySel) prioritySel.addEventListener('change', applyFilters);
        if (hideUntested) hideUntested.addEventListener('change', applyFilters);

        if (pageSizeSel) {
          pageSizeSel.value = String(pageSize);
          pageSizeSel.addEventListener('change', () => {
            const v = parseInt(pageSizeSel.value || '10', 10);
            pageSize = isNaN(v) || v <= 0 ? 10 : v;
            localStorage.setItem(pageSizeKey, String(pageSize));
            pageIndex = 0;
            renderPage();
          });
        }
        if (prevBtn) {
          prevBtn.addEventListener('click', () => {
            if (pageIndex > 0) {
              pageIndex -= 1;
              renderPage();
            }
          });
        }
        if (nextBtn) {
          nextBtn.addEventListener('click', () => {
            const maxPage = Math.max(0, Math.ceil(filteredRows.length / pageSize) - 1);
            if (pageIndex < maxPage) {
              pageIndex += 1;
              renderPage();
            }
          });
        }

        chips.forEach(ch => {
          ch.addEventListener('click', () => {
            const v = ch.getAttribute('data-status') || '';
            if (statusSel) statusSel.value = v;
            chips.forEach(c => c.classList.remove('active'));
            ch.classList.add('active');
            applyFilters();
          });
        });

        table.querySelectorAll('thead th[data-sort-by]').forEach(header => {
          header.style.cursor = 'pointer';
          header.addEventListener('click', () => {
            const sortBy = header.getAttribute('data-sort-by');
            const sortDir = header.getAttribute('data-sort-dir') === 'asc' ? 'desc' : 'asc';
            
            table.querySelectorAll('thead th[data-sort-by]').forEach(th => th.removeAttribute('data-sort-dir'));
            header.setAttribute('data-sort-dir', sortDir);

            rows.sort((a, b) => {
              const aText = a.querySelector(`td:nth-child(${header.cellIndex + 1})`).textContent.trim();
              const bText = b.querySelector(`td:nth-child(${header.cellIndex + 1})`).textContent.trim();
              const aNum = parseFloat(aText);
              const bNum = parseFloat(bText);

              let comparison = 0;
              if (!isNaN(aNum) && !isNaN(bNum)) {
                  comparison = aNum - bNum;
              } else {
                  comparison = aText.localeCompare(bText, undefined, {numeric: true});
              }
              return sortDir === 'asc' ? comparison : -comparison;
            });
            
            applyFilters();
          });
        });

        applyFilters();
      }

      const modalEl = document.getElementById('attachmentModal');
      const attachmentModal = new bootstrap.Modal(modalEl);
      const imgEl = document.getElementById('attachmentModalImage');
      const videoEl = document.getElementById('attachmentModalVideo');
      const titleEl = document.getElementById('attachmentModalTitle');
      const subtitleEl = document.getElementById('attachmentModalSubtitle');
      const counterEl = document.getElementById('attachmentCounter');
      const prevBtn = document.getElementById('prevAttachment');
      const nextBtn = document.getElementById('nextAttachment');
      let attachmentsState = [];
      let attachmentsIndex = 0;

      function updateAttachmentView() {
        if (!attachmentsState.length) {
          imgEl.style.display = 'none';
          videoEl.style.display = 'none';
          counterEl.textContent = '';
          prevBtn.disabled = true;
          nextBtn.disabled = true;
          return;
        }
        const current = attachmentsState[attachmentsIndex];
        videoEl.style.display = 'none';
        videoEl.pause();
        
        if (current.is_image && (current.data_url || current.path)) {
          imgEl.src = current.data_url || current.path;
          imgEl.alt = current.name || 'Attachment';
          imgEl.style.display = 'block';
        } else {
          imgEl.style.display = 'none';
        }
        
        if (current.is_video && (current.data_url || current.path)) {
          imgEl.style.display = 'none';
          videoEl.src = current.data_url || current.path;
          videoEl.type = current.content_type || '';
          videoEl.style.display = 'block';
          videoEl.load();
        }

        counterEl.textContent = `${attachmentsIndex + 1} / ${attachmentsState.length}`;
        prevBtn.disabled = attachmentsState.length <= 1;
        nextBtn.disabled = attachmentsState.length <= 1;
      }

      function openAttachmentModal(detail) {
        attachmentsState = detail.attachments || [];
        attachmentsIndex = 0;
        titleEl.textContent = `Attachments — ${detail.title || ''}`;
        subtitleEl.textContent = `Run ${detail.runId || ''} • Test ${detail.testId || ''}`;
        updateAttachmentView();
        attachmentModal.show();
      }

      document.addEventListener('click', function(ev) {
        const trigger = ev.target.closest('.attachment-trigger');
        if (trigger) {
          let parsed = [];
          try {
            parsed = JSON.parse(trigger.dataset.attachments || '[]');
          } catch (e) {
            console.error("Failed to parse attachments JSON", e);
            parsed = [];
          }
          openAttachmentModal({
            attachments: parsed,
            comment: trigger.dataset.comment || '',
            runId: trigger.dataset.run || '',
            testId: trigger.dataset.test || '',
            title: trigger.dataset.title || ''
          });
        }
      });

      prevBtn.addEventListener('click', function() {
        if (attachmentsState.length <= 1) return;
        attachmentsIndex = (attachmentsIndex - 1 + attachmentsState.length) % attachmentsState.length;
        updateAttachmentView();
      });
      nextBtn.addEventListener('click', function() {
        if (attachmentsState.length <= 1) return;
        attachmentsIndex = (attachmentsIndex + 1) % attachmentsState.length;
        updateAttachmentView();
      });
      
      modalEl.addEventListener('hidden.bs.modal', () => {
        videoEl.pause();
      });

      document.addEventListener('keydown', function(ev) {
        if (!modalEl.classList.contains('show')) return;
        if (ev.key === 'ArrowRight') { nextBtn.click(); }
        if (ev.key === 'ArrowLeft') { prevBtn.click(); }
      });

      document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.run-card').forEach(card => {
          setupInteractiveTable(card.getAttribute('data-run-id'));
        });
      });
    })();

    function downloadHTML() {
      try {
        const html = document.documentElement.outerHTML;
        const blob = new Blob([html], {
          type: 'text/html;charset=utf-8'
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = {{ (output_filename or 'report.html')|tojson }};
        document.body.appendChild(a);
        a.click();
        URL.revokeObjectURL(url);
        a.remove();
      } catch (e) {
        alert('Failed to download HTML: ' + e);
      }
    }
  </script>
</body>
</html>
